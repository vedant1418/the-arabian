{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="max-w-4xl mx-auto py-12 px-6">
    <h2 class="text-4xl font-extrabold text-center text-purple-800 mb-6">Book Your Stay at {{ resort.name }}</h2>

    {% if resort.image %}
    <div class="rounded-2xl overflow-hidden shadow-lg mb-8">
        <img src="{{ resort.image.url }}" alt="{{ resort.name }}" class="w-full h-72 object-cover">
    </div>
    {% endif %}

    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 text-center">
        ‚ö†Ô∏è {{ error }}
    </div>
    {% endif %}

    <form method="post" class="bg-white p-8 rounded-xl shadow-2xl space-y-6 border border-gray-200">
        {% csrf_token %}

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input name="guest_name" type="text" placeholder="John Doe" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input name="guest_email" type="email" placeholder="john@example.com" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input name="guest_phone" type="tel" placeholder="1234567890" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Check-in Date</label>
                <input name="check_in" type="date" id="check_in" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Check-out Date</label>
                <input name="check_out" type="date" id="check_out" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Number of Guests</label>
                <input name="guests" type="number" id="guests" min="1" value="1" required
                    class="border border-gray-300 p-3 rounded-lg w-full focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>
        </div>

        <div class="flex justify-between items-center pt-4">
            <p class="text-lg font-semibold text-gray-800">
                <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3-1.343-3-3S10.343 2 12 2s3 1.343 3 3-1.343 3-3 3zM19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2" />
                    </svg>
                    Total: ‚Çπ <span id="totalPrice">0</span>
                </span>
            </p>
            <span class="text-sm text-gray-500">(Auto-calculated)</span>
        </div>

        <button type="submit"
            class="bg-gradient-to-r from-purple-700 to-purple-900 hover:from-yellow-400 hover:to-yellow-500 text-white hover:text-purple-900 font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105 w-full">
            üöÄ Proceed to Payment
        </button>
    </form>
</section>

<script>
    const pricePerGuest = {{ resort.price_per_guest }};
    const form = document.querySelector("form");

    const fullName = document.querySelector("[name='guest_name']");
    const email = document.querySelector("[name='guest_email']");
    const phone = document.querySelector("[name='guest_phone']");
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const guestsInput = document.getElementById('guests');
    const totalPrice = document.getElementById('totalPrice');

    function updatePrice() {
        const guests = parseInt(guestsInput.value || 0);
        const checkIn = new Date(checkInInput.value);
        const checkOut = new Date(checkOutInput.value);
        const nights = (checkOut - checkIn) / (1000 * 60 * 60 * 24);
        const validNights = !isNaN(nights) && nights > 0;
        const total = guests * pricePerGuest * (validNights ? nights : 1);
        totalPrice.textContent = total.toFixed(2);
    }

    // Real-time price updates
    guestsInput.addEventListener('input', updatePrice);
    checkInInput.addEventListener('change', updatePrice);
    checkOutInput.addEventListener('change', updatePrice);

    form.addEventListener("submit", function (e) {
        let errors = [];

        // Full Name validation
        const namePattern = /^[a-zA-Z ]+$/;
        if (!fullName.value.trim() || !namePattern.test(fullName.value)) {
            errors.push("Full name is required and must contain only letters.");
        }

        // Email validation
        const emailPattern = /^[^@]+@[^@]+\.[^@]+$/;
        if (!emailPattern.test(email.value.trim())) {
            errors.push("Enter a valid email address.");
        }

        // Phone number validation
        const phonePattern = /^\d{10}$/;
        if (!phonePattern.test(phone.value.trim())) {
            errors.push("Phone number must be exactly 10 digits.");
        }

        // Date validations
        const checkIn = new Date(checkInInput.value);
        const checkOut = new Date(checkOutInput.value);
        const today = new Date();
        today.setHours(0,0,0,0);

        if (isNaN(checkIn.getTime()) || checkIn < today) {
            errors.push("Check-in date must be today or in the future.");
        }
        if (isNaN(checkOut.getTime()) || checkOut <= checkIn) {
            errors.push("Check-out date must be after check-in.");
        }

        // Guest number validation
        const guests = parseInt(guestsInput.value);
        if (isNaN(guests) || guests < 1 || guests > 20) {
            errors.push("Number of guests must be between 1 and 20.");
        }

        if (errors.length > 0) {
            e.preventDefault();
            alert(errors.join("\n"));  // Replace this with toast-style alert if needed
        }
    });
</script>

{% endblock %}
